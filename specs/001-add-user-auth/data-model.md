# Data Model – User Authentication Foundations

## User

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `_id` | ObjectId | Primary key | Generated by MongoDB |
| `email` | string | Required, unique, stored lowercase, RFC 5322 validation | Acts as login identifier |
| `passwordHash` | string | Required, min 60 chars, bcrypt/argon2 hash only | Managed via better-auth hashing helpers |
| `createdAt` | Date | Required, default now | Immutable audit stamp |
| `updatedAt` | Date | Required, auto-updated | Reflects last credential update |

### Derived Rules
- Reject registration when `email` already exists (unique index on `email`).  
- Enforce password policy (≥8 characters) before computing `passwordHash`.  
- Keep raw passwords transient—never persist beyond hashing step.

## Session

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `_id` | ObjectId | Primary key | Server-managed identifier |
| `sessionToken` | string | Required, unique, opaque | Issued by better-auth and stored as httpOnly cookie value |
| `userId` | ObjectId | Required, references `User._id` | Index for fast lookup |
| `expiresAt` | Date | Required, TTL index (~14 days default) | Controls automatic expiry |
| `createdAt` | Date | Required | Audit |
| `lastUsedAt` | Date | Optional, updated on access | Supports idle timeout |
| `tokenVersion` | number | Required, default 0 | Increment to revoke previously minted bearer tokens |
| `refreshTokenHash` | string | Optional, bcrypt/argon2 hash | Stored when a mobile client opts into refresh-token flow |
| `ipAddress` | string | Optional | Enables brute-force monitoring |
| `userAgent` | string | Optional | Useful for session management UI later |
| `deviceLabel` | string | Optional | Human readable tag (e.g., “iPhone 16 Pro”) for session listings |
| `clientType` | string | Required, enum(`web`,`mobile`,`service`) | Guides whether cookie or bearer credentials expected |

### State Transitions
- **Active → Refreshed**: `lastUsedAt` updated via better-auth session refresh flow.  
- **Active → Expired**: TTL index automatically deletes document after `expiresAt`.  
- **Active → Revoked**: Explicit logout deletes session document; cookie cleared; `tokenVersion` incremented prior to delete if adopting soft revoke.  
- **Expired/Revoked → Denied**: Current-user endpoint rejects requests when lookup fails or when `tokenVersion` no longer matches bearer claim.
- **Active → Rotated**: Refresh endpoint issues new access token (JWT) with current `tokenVersion`; optional replacement refresh token rewrites `refreshTokenHash`.

## Access Token (JWT)

| Claim | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `iss` | string | Required | Identifies auth service (e.g., `api.famly.local`) |
| `sub` | string | Required | Stores `userId` |
| `sid` | string | Required | Stores Mongo `Session._id` as string |
| `ver` | number | Required | Mirrors `Session.tokenVersion` to support revocation |
| `exp` | number (epoch seconds) | Required | Short lived (e.g., 15 minutes) |
| `iat` | number | Required | Issued-at timestamp |
| `scope` | string[] | Optional | Reserved for future role-based access |

### Token Handling Rules
- Validate signature via better-auth bearer plugin utilities, then check `Session` record and ensure `tokenVersion` matches the `ver` claim before honoring the token.
- Store access tokens only client-side (Secure Enclave / encrypted storage on mobile); never persist server-side.
- When `Session.tokenVersion` increments (forced logout, suspicious activity), all outstanding JWTs grounded to the session become invalid.

## Indexes
- `users.email` unique index (case-insensitive collation).  
- `sessions.sessionToken` unique index for token lookups.  
- `sessions.userId` compound with `expiresAt` to support cleanup queries.  
- `sessions.expiresAt` TTL index with configurable expiry window.  
- `sessions.clientType` partial index (filter: `clientType: { $ne: "web" }`) to accelerate bearer-token validation by narrowing to mobile/service sessions.
- `sessions.refreshTokenHash` secondary index to support O(1) lookup when issuing or revoking refresh credentials.

## Relationships
- One `User` to many `Session` records.  
- Auth endpoints always hydrate the `User` aggregate when resolving a valid `Session`; bearer validation loads `Session` by `sid`.  
- Refresh tokens (if issued) are tied 1:1 with `Session` via stored hash to allow server-side revocation.  
- Deleting a `User` should cascade to `Session` documents (manual cleanup hook to be implemented alongside delete flows in future scope).
