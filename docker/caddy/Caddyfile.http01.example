# Production Caddyfile Example - HTTP-01 Challenge (Simple Setup)
# Use this if your domain points to your home IP and ports 80/443 are forwarded
# Copy this to Caddyfile.production and customize for your domain

{
	# IMPORTANT: Configure your email for Let's Encrypt notifications
	email admin@famly.eu

	# Global security settings
	# Automatically redirect HTTP to HTTPS (Caddy does this by default)
	# Enable HTTP/2 and HTTP/3 for better performance
	servers {
		protocols h1 h2 h3
	}
}

# Your public domain - Caddy automatically handles HTTP-01 challenge
# Replace my.famly.eu with your actual domain
my.famly.eu {
	# Caddy automatically requests certificate from Let's Encrypt
	# No additional TLS configuration needed for HTTP-01!

	# Security headers
	header {
		# Enable HSTS (force HTTPS for 1 year)
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		# Enable XSS protection
		X-XSS-Protection "1; mode=block"
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server header
		-Server
	}

	# Socket.IO WebSocket connections - proxy to API service
	# Socket.IO uses /socket.io/* paths for WebSocket connections
	# Caddy automatically handles WebSocket upgrade requests
	# IMPORTANT: Use 'handle' not 'handle_path' to preserve the /socket.io/ path
	handle /socket.io/* {
		reverse_proxy api:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Next.js API routes for images - proxy to web service (Next.js)
	# These are handled by Next.js API routes, not the Express API
	# IMPORTANT: This must come BEFORE the general /api/* handler
	handle /api/images/* {
		reverse_proxy web:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# API routes - strip /api prefix and proxy to Express API service
	handle_path /api/* {
		reverse_proxy api:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Default: Proxy all other requests to web service
	handle {
		reverse_proxy web:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}
}

# To add multiple domains, just add another block:
# another-domain.com {
# 	reverse_proxy web:3000 {
# 		header_up Host {host}
# 		header_up X-Real-IP {remote}
# 		header_up X-Forwarded-For {remote}
# 		header_up X-Forwarded-Proto {scheme}
# 	}
# 	handle_path /api/* {
# 		reverse_proxy api:3001 {
# 			header_up Host {host}
# 			header_up X-Real-IP {remote}
# 			header_up X-Forwarded-For {remote}
# 			header_up X-Forwarded-Proto {scheme}
# 		}
# 	}
# }
