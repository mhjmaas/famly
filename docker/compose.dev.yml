services:
  mongo:
    image: mongo:7
    container_name: famly-mongo-dev
    ports:
      - "27017:27017" # Exposed for host inspection (MongoDB Compass, etc.)
    environment:
      MONGO_INITDB_DATABASE: famly
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - 'db.adminCommand("ping").ok'
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - famly-dev-network

  minio:
    image: minio/minio:latest
    container_name: famly-minio-dev
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    environment:
      # From .env.dev
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-famly-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-famly-dev-secret-min-32-chars}
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - famly-dev-network

  api:
    build:
      context: ..
      dockerfile: apps/api/docker/Dockerfile.dev
    container_name: famly-api-dev
    ports:
      - "3001:3001"
    depends_on:
      mongo:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      # Hardcoded Docker-internal values (not configurable)
      MONGODB_URI: mongodb://mongo:27017/famly
      NODE_ENV: development
      PORT: 3001
      MINIO_ENDPOINT: minio:9000
      MINIO_USE_SSL: "false"
      # From .env.dev
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev_better_auth_secret_min_32_chars_required_here}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001}
      CLIENT_URL: ${CLIENT_URL:-http://localhost:3000}
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-standalone}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-famly-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-famly-dev-secret-min-32-chars}
      MINIO_BUCKET: ${MINIO_BUCKET:-famly-rewards}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${NEXT_PUBLIC_VAPID_PUBLIC_KEY:-your_public_key_here}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-your_private_key_here}
      VAPID_EMAIL: ${VAPID_EMAIL:-support@famly.app}
    volumes:
      # Mount source code for live reload
      - ../apps/api/src:/app/apps/api/src:delegated
      # Mount shared package source and compiled output (with config for tsc watcher)
      - ../packages/shared/src:/app/packages/shared/src:delegated
      - ../packages/shared/dist:/app/packages/shared/dist:delegated
      - ../packages/shared/tsconfig.json:/app/packages/shared/tsconfig.json:ro
      - ../packages/shared/package.json:/app/packages/shared/package.json:ro
      # Mount config files
      - ../apps/api/tsconfig.json:/app/apps/api/tsconfig.json:ro
      # Mount package.json files (read-only to prevent accidental changes)
      - ../apps/api/package.json:/app/apps/api/package.json:ro
      - ../package.json:/app/package.json:ro
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      # Note: node_modules are NOT mounted - we use the ones from the Docker image
      # This prevents caching issues when dependencies change
    networks:
      - famly-dev-network

  web:
    build:
      context: ..
      dockerfile: apps/web/Dockerfile.dev
    container_name: famly-web-dev
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_started
      minio:
        condition: service_healthy
    environment:
      # Hardcoded Docker-internal values (not configurable)
      NODE_ENV: development
      PORT: 3000
      API_URL: http://api:3001
      MINIO_ENDPOINT: minio:9000
      MINIO_USE_SSL: "false"
      # From .env.dev
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-http://localhost:3001}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-famly-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-famly-dev-secret-min-32-chars}
      MINIO_BUCKET: ${MINIO_BUCKET:-famly-rewards}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${NEXT_PUBLIC_VAPID_PUBLIC_KEY:-your_public_key_here}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-your_private_key_here}
      VAPID_EMAIL: ${VAPID_EMAIL:-support@famly.app}
    volumes:
      # Mount source code for live reload
      - ../apps/web/src:/app/apps/web/src:delegated
      - ../apps/web/public:/app/apps/web/public:delegated
      # Mount shared package source and compiled output (with config for tsc watcher)
      - ../packages/shared/src:/app/packages/shared/src:delegated
      - ../packages/shared/dist:/app/packages/shared/dist:delegated
      - ../packages/shared/tsconfig.json:/app/packages/shared/tsconfig.json:ro
      - ../packages/shared/package.json:/app/packages/shared/package.json:ro
      # Mount config files
      - ../apps/web/next.config.ts:/app/apps/web/next.config.ts:ro
      - ../apps/web/tsconfig.json:/app/apps/web/tsconfig.json:ro
      - ../apps/web/tailwind.config.ts:/app/apps/web/tailwind.config.ts:ro
      - ../apps/web/postcss.config.mjs:/app/apps/web/postcss.config.mjs:ro
      # Mount package.json files (read-only)
      - ../apps/web/package.json:/app/apps/web/package.json:ro
      - ../package.json:/app/package.json:ro
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      # Note: node_modules are NOT mounted - we use the ones from the Docker image
      # This prevents caching issues when dependencies change
    networks:
      - famly-dev-network

  caddy:
    build:
      context: caddy
      dockerfile: Dockerfile
    container_name: famly-caddy-dev
    ports:
      - "8443:443"  # Map host port 8443 to container port 443
    depends_on:
      - web
      - api
    volumes:
      # Mount development Caddyfile configuration (localhost with mkcert)
      - ./caddy/Caddyfile.localhost:/etc/caddy/Caddyfile:ro
      # Mount certificate directory for mkcert certificates
      - ./caddy/certs:/certs:ro
      # Persist Caddy data (for Let's Encrypt certificates if used)
      - caddy-data:/data
    networks:
      - famly-dev-network
    profiles:
      - https

volumes:
  mongo-data: {}
  minio-data: {}
  caddy-data: {}

networks:
  famly-dev-network:
    driver: bridge
