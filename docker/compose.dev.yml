services:
  mongo:
    image: mongo:7
    container_name: famly-mongo-dev
    ports:
      - "27017:27017" # Exposed for host inspection (MongoDB Compass, etc.)
    environment:
      MONGO_INITDB_DATABASE: famly
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - 'db.adminCommand("ping").ok'
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - famly-dev-network

  minio:
    image: minio/minio:latest
    container_name: famly-minio-dev
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: famly-dev-access
      MINIO_ROOT_PASSWORD: famly-dev-secret-min-32-chars
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - famly-dev-network

  api:
    build:
      context: ..
      dockerfile: apps/api/docker/Dockerfile.dev
    container_name: famly-api-dev
    ports:
      - "3001:3001"
    depends_on:
      mongo:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      MONGODB_URI: mongodb://mongo:27017/famly
      NODE_ENV: development
      PORT: 3001
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev_better_auth_secret_min_32_chars_required_here}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001}
      CLIENT_URL: ${CLIENT_URL:-http://localhost:3000}
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-saas}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: famly-dev-access
      MINIO_SECRET_KEY: famly-dev-secret-min-32-chars
      MINIO_BUCKET: famly-rewards
      MINIO_USE_SSL: "false"
    volumes:
      # Mount source code for live reload
      - ../apps/api/src:/app/apps/api/src:delegated
      # Mount shared package source code
      - ../packages/shared/src:/app/packages/shared/src:delegated
      # Mount config files
      - ../apps/api/tsconfig.json:/app/apps/api/tsconfig.json:ro
      # Mount package.json files (read-only to prevent accidental changes)
      - ../apps/api/package.json:/app/apps/api/package.json:ro
      - ../package.json:/app/package.json:ro
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      # Use named volume for node_modules (better performance)
      - api-node-modules:/app/node_modules
      - api-app-node-modules:/app/apps/api/node_modules
    networks:
      - famly-dev-network

  web:
    build:
      context: ..
      dockerfile: apps/web/Dockerfile.dev
    container_name: famly-web-dev
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_started
      minio:
        condition: service_healthy
    environment:
      NODE_ENV: development
      PORT: 3000
      # Client-side API URL (browser requests through Caddy proxy or direct)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      # Client-side WebSocket URL (browser WebSocket connections through Caddy proxy or direct)
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-http://localhost:3001}
      # Server-side API URL (direct internal Docker network connection)
      API_URL: http://api:3001
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: famly-dev-access
      MINIO_SECRET_KEY: famly-dev-secret-min-32-chars
      MINIO_BUCKET: famly-rewards
      MINIO_USE_SSL: "false"
    volumes:
      # Mount source code for live reload
      - ../apps/web/src:/app/apps/web/src:delegated
      - ../apps/web/public:/app/apps/web/public:delegated
      # Mount shared package source code
      - ../packages/shared/src:/app/packages/shared/src:delegated
      # Mount config files
      - ../apps/web/next.config.ts:/app/apps/web/next.config.ts:ro
      - ../apps/web/tsconfig.json:/app/apps/web/tsconfig.json:ro
      - ../apps/web/tailwind.config.ts:/app/apps/web/tailwind.config.ts:ro
      - ../apps/web/postcss.config.mjs:/app/apps/web/postcss.config.mjs:ro
      # Mount package.json files (read-only)
      - ../apps/web/package.json:/app/apps/web/package.json:ro
      - ../package.json:/app/package.json:ro
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      # Use named volumes for node_modules (better performance)
      - web-node-modules:/app/node_modules
      - web-app-node-modules:/app/apps/web/node_modules
    networks:
      - famly-dev-network

  caddy:
    build:
      context: caddy
      dockerfile: Dockerfile
    container_name: famly-caddy-dev
    ports:
      - "8443:443"  # Map host port 8443 to container port 443
    depends_on:
      - web
      - api
    volumes:
      # Mount development Caddyfile configuration (localhost with mkcert)
      - ./caddy/Caddyfile.localhost:/etc/caddy/Caddyfile:ro
      # Mount certificate directory for mkcert certificates
      - ./caddy/certs:/certs:ro
      # Persist Caddy data (for Let's Encrypt certificates if used)
      - caddy-data:/data
    networks:
      - famly-dev-network
    profiles:
      - https

volumes:
  mongo-data: {}
  minio-data: {}
  api-node-modules: {}
  api-app-node-modules: {}
  web-node-modules: {}
  web-app-node-modules: {}
  caddy-data: {}

networks:
  famly-dev-network:
    driver: bridge
