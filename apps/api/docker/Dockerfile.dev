FROM node:20-alpine

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy monorepo workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy package.json for all workspaces (needed for pnpm workspace resolution)
COPY apps/api/package.json ./apps/api/
COPY apps/web/package.json ./apps/web/

# Copy shared packages (for development imports)
COPY packages ./packages

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build shared package (required for package.json main: ./dist/index.js)
RUN pnpm --filter @famly/shared build

# Copy and set up entrypoint script
COPY apps/api/docker/dev-entrypoint.sh /app/dev-entrypoint.sh
RUN chmod +x /app/dev-entrypoint.sh

# Set working directory to API app
WORKDIR /app/apps/api

# Expose port
EXPOSE 3001

# Run entrypoint script (starts shared watcher + dev server)
CMD ["/app/dev-entrypoint.sh"]
